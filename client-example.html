<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protest Tracker Demo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .event { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .event h3 { margin: 0 0 10px 0; color: #333; }
        .cause { background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .climate { background: #28a745; }
        .reproductive { background: #dc3545; }
        .immigration { background: #ffc107; color: #000; }
        .status { float: right; font-size: 12px; color: #666; }
        input, select { margin: 5px; padding: 5px; }
        button { padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üì¢ Protest Tracker Demo</h1>
    
    <div>
        <input type="number" id="lat" placeholder="Latitude (40.7128)" step="any">
        <input type="number" id="lng" placeholder="Longitude (-74.0060)" step="any">
        <input type="number" id="radius" placeholder="Radius (km)" value="10">
        <select id="cause">
            <option value="">All Causes</option>
            <option value="climate">Climate</option>
            <option value="reproductive">Reproductive Rights</option>
            <option value="immigration">Immigration</option>
            <option value="racial_justice">Racial Justice</option>
            <option value="lgbtq">LGBTQ Rights</option>
            <option value="labor">Labor</option>
            <option value="political">Political</option>
            <option value="other">Other</option>
        </select>
        <button onclick="searchEvents()">Search Events</button>
        <button onclick="getCurrentLocation()">Use My Location</button>
    </div>
    
    <div id="status"></div>
    <div id="events"></div>
    
    <script>
        const API_BASE = 'http://localhost:3000/api';
        const WS_URL = 'ws://localhost:8080';
        
        let ws;
        
        // Connect to WebSocket for live updates
        function connectWebSocket() {
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                document.getElementById('status').innerHTML = 'üü¢ Connected to live updates';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'new_event') {
                    showNotification(`New ${data.data.cause} event: ${data.data.title}`);
                    searchEvents(); // Refresh the list
                }
            };
            
            ws.onclose = () => {
                document.getElementById('status').innerHTML = 'üî¥ Disconnected from live updates';
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style = 'background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; margin: 10px 0; border-radius: 5px;';
            notification.textContent = `üî• ${message}`;
            document.body.insertBefore(notification, document.getElementById('events'));
            
            // Remove after 5 seconds
            setTimeout(() => notification.remove(), 5000);
        }
        
        async function searchEvents() {
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const radius = document.getElementById('radius').value;
            const cause = document.getElementById('cause').value;
            
            let url = `${API_BASE}/events?`;
            if (lat && lng) url += `lat=${lat}&lng=${lng}&`;
            if (radius) url += `radius=${radius}&`;
            if (cause) url += `causes=${cause}&`;
            
            try {
                const response = await fetch(url);
                const events = await response.json();
                displayEvents(events);
            } catch (err) {
                document.getElementById('events').innerHTML = `‚ùå Error: ${err.message}`;
            }
        }
        
        function displayEvents(events) {
            const container = document.getElementById('events');
            
            if (events.length === 0) {
                container.innerHTML = '<p>No events found in this area.</p>';
                return;
            }
            
            container.innerHTML = events.map(event => `
                <div class="event">
                    <div class="status">${event.status}</div>
                    <h3>${event.title}</h3>
                    <p><strong>üìç ${event.address}</strong></p>
                    <p>${event.description}</p>
                    <p>
                        <span class="cause ${event.cause}">${event.cause}</span>
                        üïê ${new Date(event.start_time).toLocaleString()}
                        ${event.distance_km ? `üìè ${event.distance_km.toFixed(1)}km away` : ''}
                    </p>
                </div>
            `).join('');
        }
        
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    document.getElementById('lat').value = position.coords.latitude;
                    document.getElementById('lng').value = position.coords.longitude;
                    searchEvents();
                });
            } else {
                alert('Geolocation not supported by this browser');
            }
        }
        
        // Initialize
        connectWebSocket();
        
        // Default NYC coordinates
        document.getElementById('lat').value = '40.7128';
        document.getElementById('lng').value = '-74.0060';
    </script>
</body>
</html>